# golang垃圾回收

标签：golang 语言细节 垃圾回收

内容主要来自[Go源码分析](https://github.com/qyuhen/book/blob/master/Go%201.5%20%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%20%EF%BC%88%E4%B9%A6%E7%AD%BE%E7%89%88%EF%BC%89.pdf)

为什么写这篇文章：因为垃圾回收挺重要的，我也很好奇。

## 存在的问题

启动垃圾回收的时机：过早会严重浪费CPU资源，影响用户代码执行性能。过晚，会导致堆内存恶性膨胀。

问题的核心在于抑制堆增长，充分利用CPU资源。

### 三色屏障和写屏障

这是让标记和用户代码并发的基本保障，基本原理：

* 起初所有对象都是白色。
* 扫描找出所有可达对象，标记为灰色，放入待处理队列。
* 从队列提取灰色对象，将其引用对象标记为灰色放入队列，自身标记为黑色。
* 写屏障监视对象内存修改，重新标色或放回队列。

完成全部扫描和标记工作后，剩余不是白色就是黑色，分别代表待回收和活跃对象，清理操作只需要将白色对象内存收回即可。（与操作系统内存回收类似，两次机会）

### 控制器

控制器全程参与并发回收任务，记录相关状态数据，动态调整运行策略，影响并发标记单元的工作模式和数量，平衡CPU资源占用。当回收结束后，参与next_gc回收阈值设置，调整垃圾回收触发频率。（见mgc.go）

